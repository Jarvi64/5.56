{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Process Capability Histogram with Normal Curve and Specification Limits",
  "width": 600,
  "height": 400,
  "data": {"name": "dataset"},
  "transform": [
    {
      "calculate": "datum['measuredvalue']",
      "as": "value"
    }
  ],
  "layer": [
    {
      "mark": {
        "type": "bar",
        "opacity": 0.7,
        "color": "#4682B4"
      },
      "encoding": {
        "x": {
          "bin": {"maxbins": 30},
          "field": "value",
          "type": "quantitative",
          "title": "Measured Value",
          "scale": {"zero": false}
        },
        "y": {
          "aggregate": "count",
          "type": "quantitative",
          "title": "Frequency"
        },
        "tooltip": [
          {"field": "value", "type": "quantitative", "title": "Value Range", "bin": true},
          {"aggregate": "count", "type": "quantitative", "title": "Count"}
        ]
      }
    },
    {
      "data": {
        "name": "dataset"
      },
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"},
            {"op": "min", "field": "measuredvalue", "as": "min"},
            {"op": "max", "field": "measuredvalue", "as": "max"}
          ]
        },
        {
          "calculate": "datum.mean - 4 * datum.stdev",
          "as": "range_start"
        },
        {
          "calculate": "datum.mean + 4 * datum.stdev",
          "as": "range_end"
        },
        {
          "calculate": "sequence(datum.range_start, datum.range_end, (datum.range_end - datum.range_start) / 200)",
          "as": "x_values"
        },
        {"flatten": ["x_values"]},
        {
          "calculate": "(1 / (datum.stdev * sqrt(2 * PI))) * exp(-0.5 * pow((datum.x_values - datum.mean) / datum.stdev, 2))",
          "as": "normal_density"
        }
      ],
      "mark": {
        "type": "line",
        "color": "#FF6347",
        "strokeWidth": 2.5
      },
      "encoding": {
        "x": {
          "field": "x_values",
          "type": "quantitative",
          "title": null
        },
        "y": {
          "field": "normal_density",
          "type": "quantitative",
          "title": null,
          "axis": null
        }
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"}
          ]
        }
      ],
      "mark": {
        "type": "rule",
        "color": "#2E8B57",
        "strokeWidth": 2,
        "strokeDash": [5, 5]
      },
      "encoding": {
        "x": {
          "field": "mean",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "mean", "type": "quantitative", "title": "Mean", "format": ".3f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {
          "calculate": "datum.mean - 3 * datum.stdev",
          "as": "minus_3sigma"
        }
      ],
      "mark": {
        "type": "rule",
        "color": "#FFA500",
        "strokeWidth": 2,
        "strokeDash": [8, 4]
      },
      "encoding": {
        "x": {
          "field": "minus_3sigma",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "minus_3sigma", "type": "quantitative", "title": "-3σ", "format": ".3f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {
          "calculate": "datum.mean + 3 * datum.stdev",
          "as": "plus_3sigma"
        }
      ],
      "mark": {
        "type": "rule",
        "color": "#FFA500",
        "strokeWidth": 2,
        "strokeDash": [8, 4]
      },
      "encoding": {
        "x": {
          "field": "plus_3sigma",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "plus_3sigma", "type": "quantitative", "title": "+3σ", "format": ".3f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "filter": "datum['Latest LSL'] != null"
        },
        {
          "aggregate": [
            {"op": "max", "field": "Latest LSL", "as": "lsl"}
          ]
        }
      ],
      "mark": {
        "type": "rule",
        "color": "#DC143C",
        "strokeWidth": 3
      },
      "encoding": {
        "x": {
          "field": "lsl",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "lsl", "type": "quantitative", "title": "LSL", "format": ".3f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "filter": "datum['Latest USL'] != null"
        },
        {
          "aggregate": [
            {"op": "max", "field": "Latest USL", "as": "usl"}
          ]
        }
      ],
      "mark": {
        "type": "rule",
        "color": "#DC143C",
        "strokeWidth": 3
      },
      "encoding": {
        "x": {
          "field": "usl",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "usl", "type": "quantitative", "title": "USL", "format": ".3f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "filter": "datum['Latest LSL'] != null"
        },
        {
          "aggregate": [
            {"op": "max", "field": "Latest LSL", "as": "lsl"}
          ]
        }
      ],
      "mark": {
        "type": "text",
        "align": "left",
        "dx": 5,
        "dy": -10,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "#DC143C"
      },
      "encoding": {
        "x": {
          "field": "lsl",
          "type": "quantitative"
        },
        "y": {"value": 20},
        "text": {"value": "LSL"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "filter": "datum['Latest USL'] != null"
        },
        {
          "aggregate": [
            {"op": "max", "field": "Latest USL", "as": "usl"}
          ]
        }
      ],
      "mark": {
        "type": "text",
        "align": "right",
        "dx": -5,
        "dy": -10,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "#DC143C"
      },
      "encoding": {
        "x": {
          "field": "usl",
          "type": "quantitative"
        },
        "y": {"value": 20},
        "text": {"value": "USL"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"}
          ]
        }
      ],
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -10,
        "fontSize": 11,
        "fontWeight": "bold",
        "color": "#2E8B57"
      },
      "encoding": {
        "x": {
          "field": "mean",
          "type": "quantitative"
        },
        "y": {"value": 40},
        "text": {"value": "Mean"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {
          "calculate": "datum.mean - 3 * datum.stdev",
          "as": "minus_3sigma"
        }
      ],
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -10,
        "fontSize": 10,
        "color": "#FFA500"
      },
      "encoding": {
        "x": {
          "field": "minus_3sigma",
          "type": "quantitative"
        },
        "y": {"value": 60},
        "text": {"value": "-3σ"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {
          "calculate": "datum.mean + 3 * datum.stdev",
          "as": "plus_3sigma"
        }
      ],
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -10,
        "fontSize": 10,
        "color": "#FFA500"
      },
      "encoding": {
        "x": {
          "field": "plus_3sigma",
          "type": "quantitative"
        },
        "y": {"value": 60},
        "text": {"value": "+3σ"}
      }
    }
  ],
  "config": {
    "view": {"strokeWidth": 0},
    "axis": {"labelFontSize": 11, "titleFontSize": 12}
  }
}
