{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Process Capability Histogram - Premium Design",
  "autosize": {
    "type": "fit",
    "contains": "padding"
  },
  "width": "container",
  "height": "container",
  "background": "#f8f9fa",
  "padding": 20,
  "data": {"name": "dataset"},
  "transform": [
    {"calculate": "datum['measuredvalue']", "as": "value"}
  ],
  "layer": [
    {
      "mark": {
        "type": "bar",
        "opacity": 0.75,
        "color": {
          "gradient": "linear",
          "stops": [
            {"offset": 0, "color": "#4682B4"},
            {"offset": 1, "color": "#5a9bd5"}
          ]
        },
        "cornerRadiusTopLeft": 3,
        "cornerRadiusTopRight": 3
      },
      "encoding": {
        "x": {
          "bin": {"maxbins": 35},
          "field": "value",
          "type": "quantitative",
          "title": "Measured Value",
          "scale": {"zero": false, "nice": true},
          "axis": {
            "labelFontSize": 12,
            "titleFontSize": 14,
            "titleFontWeight": 600,
            "titleColor": "#2c3e50",
            "labelColor": "#5a6c7d",
            "gridOpacity": 0.3,
            "gridDash": [2, 2]
          }
        },
        "y": {
          "aggregate": "count",
          "type": "quantitative",
          "title": "Frequency",
          "axis": {
            "labelFontSize": 12,
            "titleFontSize": 14,
            "titleFontWeight": 600,
            "titleColor": "#2c3e50",
            "labelColor": "#5a6c7d",
            "gridOpacity": 0.3,
            "gridDash": [2, 2]
          }
        },
        "tooltip": [
          {
            "field": "value",
            "type": "quantitative",
            "title": "Value Range",
            "bin": true,
            "format": ".3f"
          },
          {"aggregate": "count", "type": "quantitative", "title": "Count"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {"calculate": "datum.mean - 4 * datum.stdev", "as": "range_start"},
        {"calculate": "datum.mean + 4 * datum.stdev", "as": "range_end"},
        {
          "calculate": "sequence(datum.range_start, datum.range_end, (datum.range_end - datum.range_start) / 200)",
          "as": "x_values"
        },
        {"flatten": ["x_values"]},
        {
          "calculate": "(1 / (datum.stdev * sqrt(2 * PI))) * exp(-0.5 * pow((datum.x_values - datum.mean) / datum.stdev, 2))",
          "as": "normal_density"
        }
      ],
      "mark": {
        "type": "line",
        "color": "#e74c3c",
        "strokeWidth": 3,
        "opacity": 0.9
      },
      "encoding": {
        "x": {"field": "x_values", "type": "quantitative", "title": null},
        "y": {"field": "normal_density", "type": "quantitative", "title": null, "axis": null}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "mean", "field": "measuredvalue", "as": "mean"}]}
      ],
      "mark": {
        "type": "rule",
        "color": "#27ae60",
        "strokeWidth": 2.5,
        "strokeDash": [6, 4]
      },
      "encoding": {
        "x": {"field": "mean", "type": "quantitative"},
        "tooltip": [
          {"field": "mean", "type": "quantitative", "title": "Mean", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {"calculate": "datum.mean - 3 * datum.stdev", "as": "minus_3sigma"}
      ],
      "mark": {
        "type": "rule",
        "color": "#f39c12",
        "strokeWidth": 2,
        "strokeDash": [8, 4]
      },
      "encoding": {
        "x": {"field": "minus_3sigma", "type": "quantitative"},
        "tooltip": [
          {"field": "minus_3sigma", "type": "quantitative", "title": "-3σ", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {"calculate": "datum.mean + 3 * datum.stdev", "as": "plus_3sigma"}
      ],
      "mark": {
        "type": "rule",
        "color": "#f39c12",
        "strokeWidth": 2,
        "strokeDash": [8, 4]
      },
      "encoding": {
        "x": {"field": "plus_3sigma", "type": "quantitative"},
        "tooltip": [
          {"field": "plus_3sigma", "type": "quantitative", "title": "+3σ", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"filter": "datum['Latest LSL'] != null"},
        {"aggregate": [{"op": "max", "field": "Latest LSL", "as": "lsl"}]}
      ],
      "mark": {"type": "rule", "color": "#c0392b", "strokeWidth": 3.5},
      "encoding": {
        "x": {"field": "lsl", "type": "quantitative"},
        "tooltip": [
          {"field": "lsl", "type": "quantitative", "title": "LSL", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"filter": "datum['Latest USL'] != null"},
        {"aggregate": [{"op": "max", "field": "Latest USL", "as": "usl"}]}
      ],
      "mark": {"type": "rule", "color": "#c0392b", "strokeWidth": 3.5},
      "encoding": {
        "x": {"field": "usl", "type": "quantitative"},
        "tooltip": [
          {"field": "usl", "type": "quantitative", "title": "USL", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"filter": "datum['Latest LSL'] != null"},
        {"aggregate": [{"op": "max", "field": "Latest LSL", "as": "lsl"}]}
      ],
      "mark": {
        "type": "text",
        "align": "left",
        "dx": 8,
        "dy": -12,
        "fontSize": 13,
        "fontWeight": "bold",
        "color": "#c0392b"
      },
      "encoding": {
        "x": {"field": "lsl", "type": "quantitative"},
        "y": {"value": 25},
        "text": {"value": "LSL"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"filter": "datum['Latest USL'] != null"},
        {"aggregate": [{"op": "max", "field": "Latest USL", "as": "usl"}]}
      ],
      "mark": {
        "type": "text",
        "align": "right",
        "dx": -8,
        "dy": -12,
        "fontSize": 13,
        "fontWeight": "bold",
        "color": "#c0392b"
      },
      "encoding": {
        "x": {"field": "usl", "type": "quantitative"},
        "y": {"value": 25},
        "text": {"value": "USL"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "mean", "field": "measuredvalue", "as": "mean"}]}
      ],
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -12,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "#27ae60"
      },
      "encoding": {
        "x": {"field": "mean", "type": "quantitative"},
        "y": {"value": 45},
        "text": {"value": "μ"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {"calculate": "datum.mean - 3 * datum.stdev", "as": "minus_3sigma"}
      ],
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -12,
        "fontSize": 11,
        "fontWeight": 600,
        "color": "#f39c12"
      },
      "encoding": {
        "x": {"field": "minus_3sigma", "type": "quantitative"},
        "y": {"value": 65},
        "text": {"value": "-3σ"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"}
          ]
        },
        {"calculate": "datum.mean + 3 * datum.stdev", "as": "plus_3sigma"}
      ],
      "mark": {
        "type": "text",
        "align": "center",
        "dy": -12,
        "fontSize": 11,
        "fontWeight": 600,
        "color": "#f39c12"
      },
      "encoding": {
        "x": {"field": "plus_3sigma", "type": "quantitative"},
        "y": {"value": 65},
        "text": {"value": "+3σ"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "joinaggregate": [
            {"op": "distinct", "field": "Cp", "as": "cp_value"},
            {"op": "distinct", "field": "Cpk", "as": "cpk_value"},
            {"op": "max", "field": "Latest LSL", "as": "lsl"},
            {"op": "max", "field": "Latest USL", "as": "usl"},
            {"op": "count", "as": "total_count"}
          ]
        },
        {
          "aggregate": [
            {"op": "max", "field": "cp_value", "as": "cp"},
            {"op": "max", "field": "cpk_value", "as": "cpk"},
            {"op": "max", "field": "lsl", "as": "lsl"},
            {"op": "max", "field": "usl", "as": "usl"},
            {"op": "max", "field": "total_count", "as": "n"}
          ]
        }
      ],
      "layer": [
        {
          "mark": {
            "type": "rect",
            "xc": 130,
            "yc": 95,
            "width": 240,
            "height": 170,
            "fill": "white",
            "stroke": "#bdc3c7",
            "strokeWidth": 1,
            "cornerRadius": 12,
            "opacity": 0.97
          }
        },
        {
          "mark": {
            "type": "rect",
            "xc": 130,
            "yc": 30,
            "width": 240,
            "height": 40,
            "fill": "#34495e",
            "cornerRadius": 12,
            "opacity": 1
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 130,
            "y": 30,
            "fontSize": 16,
            "fontWeight": "bold",
            "color": "white"
          },
          "encoding": {"text": {"value": "Process Capability"}}
        },
        {
          "mark": {
            "type": "text",
            "x": 40,
            "y": 70,
            "align": "left",
            "fontSize": 14,
            "fontWeight": 600,
            "color": "#34495e"
          },
          "encoding": {"text": {"value": "Cp"}}
        },
        {
          "mark": {
            "type": "text",
            "x": 160,
            "y": 70,
            "align": "right",
            "fontSize": 16,
            "fontWeight": "bold",
            "color": "#2c3e50"
          },
          "encoding": {
            "text": {"field": "cp", "type": "quantitative", "format": ".3f"}
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 40,
            "y": 100,
            "align": "left",
            "fontSize": 14,
            "fontWeight": 600,
            "color": "#34495e"
          },
          "encoding": {"text": {"value": "Cpk"}}
        },
        {
          "mark": {
            "type": "text",
            "x": 160,
            "y": 100,
            "align": "right",
            "fontSize": 16,
            "fontWeight": "bold",
            "color": "#2c3e50"
          },
          "encoding": {
            "text": {"field": "cpk", "type": "quantitative", "format": ".3f"}
          }
        },
        {
          "transform": [
            {
              "calculate": "datum.cpk >= 1.33 ? '#27ae60' : datum.cpk >= 1.0 ? '#f39c12' : '#e74c3c'",
              "as": "status_color"
            },
            {
              "calculate": "datum.cpk >= 1.33 ? 'Capable' : datum.cpk >= 1.0 ? 'Marginal' : 'Incapable'",
              "as": "status_text"
            }
          ],
          "mark": {
            "type": "rect",
            "xc": 198,
            "yc": 100,
            "width": 70,
            "height": 28,
            "cornerRadius": 6
          },
          "encoding": {
            "fill": {"field": "status_color", "type": "nominal", "legend": null}
          }
        },
        {
          "transform": [
            {
              "calculate": "datum.cpk >= 1.33 ? 'Capable' : datum.cpk >= 1.0 ? 'Marginal' : 'Incapable'",
              "as": "status_text"
            }
          ],
          "mark": {
            "type": "text",
            "x": 198,
            "y": 100,
            "align": "center",
            "fontSize": 12,
            "fontWeight": "bold",
            "color": "white"
          },
          "encoding": {"text": {"field": "status_text", "type": "nominal"}}
        },
        {
          "mark": {
            "type": "text",
            "x": 40,
            "y": 135,
            "align": "left",
            "fontSize": 13,
            "fontWeight": 600,
            "color": "#34495e"
          },
          "encoding": {"text": {"value": "Within Spec"}}
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "joinaggregate": [
                {"op": "max", "field": "Latest LSL", "as": "lsl_limit"},
                {"op": "max", "field": "Latest USL", "as": "usl_limit"}
              ]
            },
            {
              "filter": "datum.measuredvalue >= datum.lsl_limit && datum.measuredvalue <= datum.usl_limit"
            },
            {"joinaggregate": [{"op": "count", "as": "within_count"}]},
            {"joinaggregate": [{"op": "count", "as": "total_count"}]},
            {
              "calculate": "(datum.within_count / datum.total_count) * 100",
              "as": "percent_within"
            },
            {"aggregate": [{"op": "max", "field": "percent_within", "as": "pct"}]}
          ],
          "mark": {
            "type": "text",
            "x": 210,
            "y": 135,
            "align": "right",
            "fontSize": 16,
            "fontWeight": "bold",
            "color": "#27ae60"
          },
          "encoding": {
            "text": {"field": "pct", "type": "quantitative", "format": ".1f"}
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 215,
            "y": 135,
            "align": "left",
            "fontSize": 16,
            "fontWeight": "bold",
            "color": "#27ae60"
          },
          "encoding": {"text": {"value": "%"}}
        },
        {
          "mark": {
            "type": "text",
            "x": 40,
            "y": 160,
            "align": "left",
            "fontSize": 12,
            "color": "#7f8c8d",
            "fontStyle": "italic"
          },
          "encoding": {"text": {"value": "Sample Size"}}
        },
        {
          "mark": {
            "type": "text",
            "x": 220,
            "y": 160,
            "align": "right",
            "fontSize": 13,
            "fontWeight": "bold",
            "color": "#34495e"
          },
          "encoding": {"text": {"field": "n", "type": "quantitative"}}
        }
      ]
    }
  ],
  "config": {
    "view": {"strokeWidth": 0},
    "axis": {
      "domainColor": "#bdc3c7",
      "tickColor": "#bdc3c7"
    }
  }
}
