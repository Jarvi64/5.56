{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Production Floor Status Dashboard for Deneb (Power BI)",
    "data": {
        "name": "dataset"
    },
    "title": {
        "text": "ðŸ­ Production Floor Status",
        "fontSize": 20,
        "fontWeight": "bold",
        "color": "#1e293b",
        "anchor": "start",
        "offset": 20
    },
    "background": "#f8fafc",
    "padding": {
        "left": 120,
        "right": 20,
        "top": 20,
        "bottom": 20
    },
    "transform": [
        {
            "joinaggregate": [
                {
                    "op": "sum",
                    "field": "Produced",
                    "as": "Total_Produced"
                },
                {
                    "op": "sum",
                    "field": "Target",
                    "as": "Total_Target"
                },
                {
                    "op": "max",
                    "field": "Is_Down",
                    "as": "Any_Down"
                },
                {
                    "op": "sum",
                    "field": "Downtime_Mins",
                    "as": "Total_DT"
                },
                {
                    "op": "distinct",
                    "field": "Varient",
                    "as": "Variant_Count"
                },
                {
                    "op": "min",
                    "field": "Varient",
                    "as": "First_Variant"
                },
                {
                    "op": "min",
                    "field": "line_sort_order",
                    "as": "line_sort_order"
                },
                {
                    "op": "min",
                    "field": "wc_sort_order",
                    "as": "wc_sort_order"
                },
                {
                    "op": "mean",
                    "field": "OEE",
                    "as": "Avg_OEE"
                }
            ],
            "groupby": [
                "Line",
                "wc_name"
            ]
        },
        {
            "window": [
                {
                    "op": "row_number",
                    "as": "dedup_rank"
                }
            ],
            "groupby": [
                "Line",
                "wc_name"
            ]
        },
        {
            "filter": "datum.dedup_rank == 1"
        },
        {
            "window": [
                {
                    "op": "dense_rank",
                    "as": "line_rank"
                }
            ],
            "sort": [
                {
                    "field": "line_sort_order",
                    "order": "ascending"
                }
            ]
        },
        {
            "window": [
                {
                    "op": "row_number",
                    "as": "wc_rank"
                }
            ],
            "groupby": [
                "Line"
            ],
            "sort": [
                {
                    "field": "wc_sort_order",
                    "order": "ascending"
                }
            ]
        },
        {
            "calculate": "(datum.wc_rank - 1) % 5",
            "as": "col_index"
        },
        {
            "calculate": "floor((datum.wc_rank - 1) / 5)",
            "as": "row_index"
        },
        {
            "calculate": "datum.Total_Produced / datum.Total_Target",
            "as": "Achievement_Pct"
        },
        {
            "calculate": "datum.Any_Down ? 'DOWNTIME' : (!isValid(datum.Total_Produced) ? 'NO DATA' : 'RUNNING')",
            "as": "Status_Text"
        },
        {
            "calculate": "datum.Any_Down ? '#ef4444' : (!isValid(datum.Total_Produced) ? '#94a3b8' : '#22c55e')",
            "as": "Status_Color"
        },
        {
            "calculate": "datum.Any_Down ? '#fee2e2' : (!isValid(datum.Total_Produced) ? '#f1f5f9' : '#dcfce7')",
            "as": "Pill_BG"
        },
        {
            "calculate": "datum.Any_Down ? '#991b1b' : (!isValid(datum.Total_Produced) ? '#64748b' : '#166534')",
            "as": "Pill_Text_Color"
        },
        {
            "calculate": "datum.Total_Produced >= 1000000 ? format(datum.Total_Produced/1000000, '.1f') + 'M' : (datum.Total_Produced >= 1000 ? format(datum.Total_Produced/1000, '.1f') + 'K' : datum.Total_Produced)",
            "as": "Produced_Formatted"
        },
        {
            "calculate": "(isValid(datum.Total_Target) ? format(datum.Total_Target, ',d') : '-') + ' Tgt'",
            "as": "Target_Label"
        },
        {
            "calculate": "datum.Total_DT > 0 ? (datum.Total_DT > 60 ? 'â± ' + format(datum.Total_DT / 60, '.1f') + 'h' : 'â± ' + datum.Total_DT + 'm') : ''",
            "as": "Downtime_Label"
        },
        {
            "calculate": "isValid(datum.Avg_OEE) ? 'OEE ' + format(datum.Avg_OEE, '.0%') : ''",
            "as": "OEE_Label"
        },
        {
            "calculate": "isValid(datum.Total_Target) && isValid(datum.Total_Produced) ? max(0, datum.Total_Target - datum.Total_Produced) : 0",
            "as": "Remaining_Qty"
        },
        {
            "calculate": "datum.Total_Target > 0 ? (datum.Remaining_Qty / datum.Total_Target) : 0",
            "as": "Remaining_Pct"
        },
        {
            "calculate": "datum.Total_Target > 0 && isValid(datum.Total_Produced) ? abs(datum.Total_Produced - datum.Total_Target) / datum.Total_Target : 0",
            "as": "Variance_Pct"
        },
        {
            "calculate": "abs(datum.Total_Produced - datum.Total_Target) >= 1000000 ? format(abs(datum.Total_Produced - datum.Total_Target)/1000000, '.1f') + 'M' : (abs(datum.Total_Produced - datum.Total_Target) >= 1000 ? format(abs(datum.Total_Produced - datum.Total_Target)/1000, '.1f') + 'K' : abs(datum.Total_Produced - datum.Total_Target))",
            "as": "Variance_Formatted"
        },
        {
            "calculate": "!isValid(datum.Total_Target) || !isValid(datum.Total_Produced) ? '' : (datum.Total_Target == 0 && datum.Total_Produced == 0 ? '' : (datum.Total_Produced >= datum.Total_Target ? ('âœ“ ' + (datum.Total_Produced > datum.Total_Target ? 'Ahead by ' + datum.Variance_Formatted + ' (' + format(datum.Variance_Pct, '.0%') + ')' : 'On Target')) : ('âš  Behind by ' + datum.Variance_Formatted + ' (' + format(datum.Variance_Pct, '.0%') + ')')))",
            "as": "Remaining_Label"
        },
        {
            "calculate": "!isValid(datum.Total_Target) || !isValid(datum.Total_Produced) || (datum.Total_Target == 0 && datum.Total_Produced == 0) ? '#94a3b8' : (datum.Total_Produced >= datum.Total_Target ? '#22c55e' : '#ef4444')",
            "as": "Remaining_Color"
        },
        {
            "calculate": "datum.Variant_Count > 1 ? datum.First_Variant + ' +' + (datum.Variant_Count - 1) : (isValid(datum.First_Variant) ? datum.First_Variant : '')",
            "as": "Variant_Label"
        }
    ],
    "facet": {
        "row": {
            "field": "Line",
            "type": "nominal",
            "title": null,
            "sort": {
                "field": "line_sort_order",
                "order": "ascending"
            },
            "header": {
                "labels": false,
                "title": null
            }
        }
    },
    "resolve": {
        "scale": {
            "y": "independent"
        }
    },
    "spec": {
        "width": {
            "step": 230
        },
        "height": {
            "step": 150
        },
        "layer": [
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "middle",
                    "dx": -25,
                    "fontSize": 16,
                    "fontWeight": "bold",
                    "color": "#64748b"
                },
                "encoding": {
                    "text": {
                        "field": "Line"
                    },
                    "x": {
                        "value": 0
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal",
                        "axis": null
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.wc_rank == 1",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "cornerRadius": 12,
                    "fill": "white",
                    "stroke": "#e2e8f0",
                    "strokeWidth": 1,
                    "width": 220,
                    "height": 130,
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal",
                        "axis": null,
                        "scale": {
                            "step": 230
                        }
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal",
                        "axis": null,
                        "scale": {
                            "step": 150
                        }
                    }
                }
            },
            {
                "mark": {
                    "type": "image",
                    "width": 218,
                    "height": 128,
                    "cornerRadius": 12,
                    "opacity": 1,
                    "url": "data:image/svg+xml;utf8,%3Csvg%20width%3D%22180%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cdefs%3E%3Cpattern%20id%3D%22p_red%22%20width%3D%2210%22%20height%3D%2210%22%20patternUnits%3D%22userSpaceOnUse%22%3E%3Cpath%20d%3D%22M-2%2C2%20l4%2C-4%20M0%2C10%20l10%2C-10%20M8%2C12%20l4%2C-4%22%20stroke%3D%22%23ef4444%22%20stroke-width%3D%221.5%22%2F%3E%3C%2Fpattern%3E%3C%2Fdefs%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22url(%23p_red)%22%3E%3Canimate%20attributeName%3D%22opacity%22%20values%3D%220.1%3B0.6%3B0.1%22%20dur%3D%221.5s%22%20repeatCount%3D%22indefinite%22%2F%3E%3C%2Frect%3E%3C%2Fsvg%3E"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Any_Down",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "image",
                    "width": 218,
                    "height": 128,
                    "cornerRadius": 12,
                    "opacity": 0.5,
                    "url": "data:image/svg+xml;utf8,%3Csvg%20width%3D%22180%22%20height%3D%22100%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%3Cdefs%3E%3Cpattern%20id%3D%22p_gray%22%20width%3D%2210%22%20height%3D%2210%22%20patternUnits%3D%22userSpaceOnUse%22%3E%3Cpath%20d%3D%22M-2%2C2%20l4%2C-4%20M0%2C10%20l10%2C-10%20M8%2C12%20l4%2C-4%22%20stroke%3D%22%23cbd5e1%22%20stroke-width%3D%221.5%22%2F%3E%3C%2Fpattern%3E%3C%2Fdefs%3E%3Crect%20width%3D%22100%25%22%20height%3D%22100%25%22%20fill%3D%22url(%23p_gray)%22%2F%3E%3C%2Fsvg%3E"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "opacity": {
                        "condition": {
                            "test": "!isValid(datum.Total_Produced) && !datum.Any_Down",
                            "value": 0.4
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "width": 6,
                    "height": 130,
                    "cornerRadiusTopLeft": 12,
                    "cornerRadiusBottomLeft": 12,
                    "xOffset": -107
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "color": {
                        "field": "Status_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "top",
                    "dx": -95,
                    "dy": -53,
                    "fontSize": 13,
                    "fontWeight": "bold",
                    "color": "#475569"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "wc_name"
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "top",
                    "dx": -95,
                    "dy": -36,
                    "fontSize": 10,
                    "fontWeight": "normal",
                    "color": "#94a3b8",
                    "fontStyle": "italic"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Variant_Label"
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Variant_Label != ''",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "cornerRadius": 100,
                    "height": 20,
                    "width": 80,
                    "xOffset": 65,
                    "yOffset": -50
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "color": {
                        "field": "Pill_BG",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "center",
                    "baseline": "middle",
                    "dx": 65,
                    "dy": -49,
                    "fontSize": 9,
                    "fontWeight": "bold"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Status_Text"
                    },
                    "color": {
                        "field": "Pill_Text_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "middle",
                    "dx": -95,
                    "dy": 0,
                    "fontSize": 28,
                    "fontWeight": "bold"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Produced_Formatted"
                    },
                    "color": {
                        "field": "Status_Color",
                        "scale": null
                    },
                    "opacity": {
                        "condition": {
                            "test": "!isValid(datum.Total_Produced)",
                            "value": 0
                        },
                        "value": 1
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "bottom",
                    "dx": -95,
                    "dy": 53,
                    "fontSize": 12,
                    "fontWeight": "bold",
                    "color": "#64748b"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "OEE_Label"
                    },
                    "opacity": {
                        "condition": {
                            "test": "!isValid(datum.Total_Produced)",
                            "value": 0
                        },
                        "value": 1
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 13,
                    "fontSize": 12,
                    "color": "#64748b"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Target_Label"
                    },
                    "opacity": {
                        "condition": {
                            "test": "!isValid(datum.Total_Target)",
                            "value": 0
                        },
                        "value": 1
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 33,
                    "fontSize": 9,
                    "fontWeight": "bold"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Remaining_Label"
                    },
                    "color": {
                        "field": "Remaining_Color",
                        "scale": null
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Remaining_Label != ''",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 53,
                    "fontSize": 12,
                    "fontWeight": "bold",
                    "color": "#ef4444"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Downtime_Label"
                    }
                }
            }
        ]
    },
    "config": {
        "view": {
            "stroke": null
        },
        "facet": {
            "spacing": 20
        },
        "axis": {
            "grid": false
        }
    }
}
