{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Production Floor Status Dashboard for Deneb (Power BI)",
    "data": {
        "name": "dataset"
    },
    "params": [
        {
            "name": "shift_progress",
            "expr": "clamp((now() - datetime(year(now()), month(now()), date(now()), 8, 0, 0)) / (datetime(year(now()), month(now()), date(now()), 20, 0, 0) - datetime(year(now()), month(now()), date(now()), 8, 0, 0)), 0.01, 1)"
        }
    ],
    "title": {
        "text": "ðŸ­ Production Floor Status",
        "fontSize": 20,
        "fontWeight": "bold",
        "color": "#1e293b",
        "anchor": "start",
        "offset": 20
    },
    "background": "#f8fafc",
    "padding": {
        "left": 120,
        "right": 20,
        "top": 20,
        "bottom": 20
    },
    "transform": [
        {
            "joinaggregate": [
                {
                    "op": "sum",
                    "field": "Produced",
                    "as": "Total_Produced"
                },
                {
                    "op": "sum",
                    "field": "Target",
                    "as": "Total_Target"
                },
                {
                    "op": "max",
                    "field": "Is_Down",
                    "as": "Any_Down"
                },
                {
                    "op": "sum",
                    "field": "Downtime_Mins",
                    "as": "Total_DT"
                },
                {
                    "op": "mean",
                    "field": "OEE",
                    "as": "Avg_OEE"
                }
            ],
            "groupby": [
                "Line",
                "wc_name"
            ]
        },
        {
            "window": [
                {
                    "op": "row_number",
                    "as": "dedup_rank"
                }
            ],
            "groupby": [
                "Line",
                "wc_name"
            ]
        },
        {
            "filter": "datum.dedup_rank == 1"
        },
        {
            "window": [
                {
                    "op": "dense_rank",
                    "as": "line_rank"
                }
            ],
            "sort": [
                {
                    "field": "Line"
                }
            ]
        },
        {
            "window": [
                {
                    "op": "row_number",
                    "as": "wc_rank"
                }
            ],
            "groupby": [
                "Line"
            ],
            "sort": [
                {
                    "field": "wc_name"
                }
            ]
        },
        {
            "calculate": "(datum.wc_rank - 1) % 5",
            "as": "col_index"
        },
        {
            "calculate": "floor((datum.wc_rank - 1) / 5)",
            "as": "row_index"
        },
        {
            "calculate": "datum.Total_Produced / datum.Total_Target",
            "as": "Achievement_Pct"
        },
        {
            "calculate": "datum.Any_Down ? 'DOWNTIME' : (!isValid(datum.Total_Produced) ? 'NO DATA' : 'RUNNING')",
            "as": "Status_Text"
        },
        {
            "calculate": "datum.Any_Down ? '#ef4444' : (!isValid(datum.Total_Produced) ? '#94a3b8' : '#22c55e')",
            "as": "Status_Color"
        },
        {
            "calculate": "datum.Any_Down ? '#fee2e2' : (!isValid(datum.Total_Produced) ? '#f1f5f9' : '#dcfce7')",
            "as": "Pill_BG"
        },
        {
            "calculate": "datum.Any_Down ? '#991b1b' : (!isValid(datum.Total_Produced) ? '#64748b' : '#166534')",
            "as": "Pill_Text_Color"
        },
        {
            "calculate": "datum.Total_Produced >= 1000000 ? format(datum.Total_Produced/1000000, '.1f') + 'M' : (datum.Total_Produced >= 1000 ? format(datum.Total_Produced/1000, '.1f') + 'K' : datum.Total_Produced)",
            "as": "Produced_Formatted"
        },
        {
            "calculate": "(isValid(datum.Total_Target) ? format(datum.Total_Target, ',d') : '-') + ' Tgt'",
            "as": "Target_Label"
        },
        {
            "calculate": "datum.Total_DT > 0 ? 'â± ' + datum.Total_DT + 'm' : ''",
            "as": "Downtime_Label"
        },
        {
            "calculate": "isValid(datum.Avg_OEE) ? 'OEE ' + format(datum.Avg_OEE, '.0%') : ''",
            "as": "OEE_Label"
        },
        {
            "calculate": "max(0, datum.Total_Target - datum.Total_Produced)",
            "as": "Remaining_Qty"
        },
        {
            "calculate": "datum.Total_Target > 0 ? (datum.Remaining_Qty / datum.Total_Target) : 0",
            "as": "Remaining_Pct"
        },
        {
            "calculate": "datum.Remaining_Qty > 0 ? format(datum.Remaining_Qty, ',d') + ' (' + format(datum.Remaining_Pct, '.0%') + ') Remaining' : 'Target Achieved'",
            "as": "Remaining_Label"
        }
    ],
    "facet": {
        "row": {
            "field": "Line",
            "type": "nominal",
            "title": null,
            "header": {
                "labels": false,
                "title": null
            }
        }
    },
    "resolve": {
        "scale": {
            "y": "independent"
        }
    },
    "spec": {
        "width": {
            "step": 230
        },
        "height": {
            "step": 150
        },
        "layer": [
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "middle",
                    "dx": -25,
                    "fontSize": 16,
                    "fontWeight": "bold",
                    "color": "#64748b"
                },
                "encoding": {
                    "text": {
                        "field": "Line"
                    },
                    "x": {
                        "value": 0
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal",
                        "axis": null
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.wc_rank == 1",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "cornerRadius": 12,
                    "fill": "white",
                    "stroke": "#e2e8f0",
                    "strokeWidth": 1,
                    "width": 220,
                    "height": 130,
                    "cursor": "pointer"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal",
                        "axis": null,
                        "scale": {
                            "step": 230
                        }
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal",
                        "axis": null,
                        "scale": {
                            "step": 150
                        }
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "width": 6,
                    "height": 130,
                    "cornerRadiusTopLeft": 12,
                    "cornerRadiusBottomLeft": 12,
                    "xOffset": -107
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "color": {
                        "field": "Status_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "top",
                    "dx": -95,
                    "dy": -53,
                    "fontSize": 13,
                    "fontWeight": "bold",
                    "color": "#475569"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "wc_name"
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "cornerRadius": 100,
                    "height": 20,
                    "width": 80,
                    "xOffset": 65,
                    "yOffset": -50
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "color": {
                        "field": "Pill_BG",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "center",
                    "baseline": "middle",
                    "dx": 65,
                    "dy": -49,
                    "fontSize": 9,
                    "fontWeight": "bold"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Status_Text"
                    },
                    "color": {
                        "field": "Pill_Text_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "middle",
                    "dx": -95,
                    "dy": 0,
                    "fontSize": 28,
                    "fontWeight": "bold"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Produced_Formatted"
                    },
                    "color": {
                        "field": "Status_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "bottom",
                    "dx": -95,
                    "dy": 53,
                    "fontSize": 12,
                    "fontWeight": "bold",
                    "color": "#64748b"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "OEE_Label"
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 13,
                    "fontSize": 12,
                    "color": "#94a3b8"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Target_Label"
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 33,
                    "fontSize": 9,
                    "fontWeight": "bold",
                    "color": "#64748b"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Remaining_Label"
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 53,
                    "fontSize": 12,
                    "fontWeight": "bold",
                    "color": "#ef4444"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Downtime_Label"
                    }
                }
            }
        ]
    },
    "config": {
        "view": {
            "stroke": null
        },
        "facet": {
            "spacing": 20
        },
        "axis": {
            "grid": false
        }
    }
}
