{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Process Capability Histogram",
  "autosize": {
    "type": "fit",
    "contains": "padding"
  },
  "width": "container",
  "height": "container",
  "data": {"name": "dataset"},
  "layer": [
    {
      "mark": {
        "type": "bar",
        "color": "#4682B4",
        "opacity": 0.7
      },
      "encoding": {
        "x": {
          "bin": {"maxbins": 30},
          "field": "measuredvalue",
          "type": "quantitative",
          "title": "Measured Value"
        },
        "y": {
          "aggregate": "count",
          "type": "quantitative",
          "title": "Frequency"
        },
        "tooltip": [
          {"bin": true, "field": "measuredvalue", "type": "quantitative", "title": "Range"},
          {"aggregate": "count", "type": "quantitative", "title": "Frequency"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "mean"},
            {"op": "stdev", "field": "measuredvalue", "as": "stdev"},
            {"op": "count", "as": "total_count"}
          ]
        },
        {"calculate": "datum.mean - 4 * datum.stdev", "as": "x_min"},
        {"calculate": "datum.mean + 4 * datum.stdev", "as": "x_max"},
        {"calculate": "sequence(datum.x_min, datum.x_max, (datum.x_max - datum.x_min) / 100)", "as": "x_seq"},
        {"flatten": ["x_seq"]},
        {"calculate": "datum.x_seq", "as": "x"},
        {
          "calculate": "(1 / (datum.stdev * sqrt(2 * PI))) * exp(-0.5 * pow((datum.x - datum.mean) / datum.stdev, 2))",
          "as": "density"
        },
        {
          "calculate": "datum.density * datum.total_count * ((datum.x_max - datum.x_min) / 30)",
          "as": "y"
        }
      ],
      "mark": {
        "type": "line",
        "color": "red",
        "strokeWidth": 2.5
      },
      "encoding": {
        "x": {
          "field": "x",
          "type": "quantitative"
        },
        "y": {
          "field": "y",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "mean", "type": "quantitative", "title": "Mean", "format": ".4f"},
          {"field": "stdev", "type": "quantitative", "title": "Std Dev", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "mean", "field": "measuredvalue", "as": "mean_value"}]}
      ],
      "mark": {
        "type": "rule",
        "strokeDash": [5, 5],
        "color": "green",
        "strokeWidth": 2
      },
      "encoding": {
        "x": {
          "field": "mean_value",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "mean_value", "type": "quantitative", "title": "Mean", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "mean", "field": "measuredvalue", "as": "mean_value"}]}
      ],
      "mark": {
        "type": "text",
        "dy": -10,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "green"
      },
      "encoding": {
        "x": {
          "field": "mean_value",
          "type": "quantitative"
        },
        "y": {"value": 0},
        "text": {"field": "mean_value", "type": "quantitative", "format": ".3f"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "mean", "field": "measuredvalue", "as": "mean_value"}]}
      ],
      "mark": {
        "type": "text",
        "dy": -25,
        "fontSize": 11,
        "fontWeight": "600",
        "color": "green"
      },
      "encoding": {
        "x": {
          "field": "mean_value",
          "type": "quantitative"
        },
        "y": {"value": 0},
        "text": {"value": "Mean"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "max", "field": "Latest LSL", "as": "lsl_value"}]}
      ],
      "mark": {
        "type": "rule",
        "strokeDash": [5, 5],
        "color": "red",
        "strokeWidth": 2
      },
      "encoding": {
        "x": {
          "field": "lsl_value",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "lsl_value", "type": "quantitative", "title": "LSL", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "max", "field": "Latest LSL", "as": "lsl_value"}]}
      ],
      "mark": {
        "type": "text",
        "dy": -10,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "red",
        "align": "center"
      },
      "encoding": {
        "x": {
          "field": "lsl_value",
          "type": "quantitative"
        },
        "y": {"value": 0},
        "text": {"field": "lsl_value", "type": "quantitative", "format": ".3f"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "max", "field": "Latest LSL", "as": "lsl_value"}]}
      ],
      "mark": {
        "type": "text",
        "dy": -25,
        "fontSize": 11,
        "fontWeight": "600",
        "color": "red",
        "align": "center"
      },
      "encoding": {
        "x": {
          "field": "lsl_value",
          "type": "quantitative"
        },
        "y": {"value": 0},
        "text": {"value": "LSL"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "max", "field": "Latest USL", "as": "usl_value"}]}
      ],
      "mark": {
        "type": "rule",
        "strokeDash": [5, 5],
        "color": "red",
        "strokeWidth": 2
      },
      "encoding": {
        "x": {
          "field": "usl_value",
          "type": "quantitative"
        },
        "tooltip": [
          {"field": "usl_value", "type": "quantitative", "title": "USL", "format": ".4f"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "max", "field": "Latest USL", "as": "usl_value"}]}
      ],
      "mark": {
        "type": "text",
        "dy": -10,
        "fontSize": 12,
        "fontWeight": "bold",
        "color": "red",
        "align": "center"
      },
      "encoding": {
        "x": {
          "field": "usl_value",
          "type": "quantitative"
        },
        "y": {"value": 0},
        "text": {"field": "usl_value", "type": "quantitative", "format": ".3f"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {"aggregate": [{"op": "max", "field": "Latest USL", "as": "usl_value"}]}
      ],
      "mark": {
        "type": "text",
        "dy": -25,
        "fontSize": 11,
        "fontWeight": "600",
        "color": "red",
        "align": "center"
      },
      "encoding": {
        "x": {
          "field": "usl_value",
          "type": "quantitative"
        },
        "y": {"value": 0},
        "text": {"value": "USL"}
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "window": [{"op": "lag", "field": "measuredvalue", "as": "prev_value"}],
          "sort": [{"field": "lot_breaker_id"}]
        },
        {
          "calculate": "abs(datum.measuredvalue - datum.prev_value)",
          "as": "moving_range"
        },
        {
          "joinaggregate": [
            {"op": "mean", "field": "moving_range", "as": "rbar"},
            {"op": "max", "field": "sampleqty", "as": "subgroup_size"},
            {"op": "max", "field": "Latest LSL", "as": "lsl"},
            {"op": "max", "field": "Latest USL", "as": "usl"},
            {"op": "mean", "field": "measuredvalue", "as": "mean"}
          ]
        },
        {
          "calculate": "datum.subgroup_size == 2 ? 1.128 : datum.subgroup_size == 3 ? 1.693 : datum.subgroup_size == 4 ? 2.059 : datum.subgroup_size == 5 ? 2.326 : 1.128",
          "as": "d2"
        },
        {
          "calculate": "datum.rbar / datum.d2",
          "as": "sigma_within"
        },
        {
          "aggregate": [
            {"op": "max", "field": "sigma_within", "as": "sigma"},
            {"op": "max", "field": "lsl", "as": "lsl"},
            {"op": "max", "field": "usl", "as": "usl"},
            {"op": "max", "field": "mean", "as": "mean"},
            {"op": "count", "as": "n"}
          ]
        },
        {
          "calculate": "(datum.usl - datum.lsl) / (6 * datum.sigma)",
          "as": "cp_value"
        },
        {
          "calculate": "min((datum.usl - datum.mean) / (3 * datum.sigma), (datum.mean - datum.lsl) / (3 * datum.sigma))",
          "as": "cpk_value"
        }
      ],
      "layer": [
        {
          "mark": {
            "type": "rect",
            "x": 10,
            "y": 10,
            "x2": 180,
            "y2": 100,
            "fill": "white",
            "stroke": "#333",
            "strokeWidth": 2,
            "cornerRadius": 8,
            "opacity": 0.95
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 95,
            "y": 30,
            "fontSize": 14,
            "fontWeight": "bold",
            "color": "#333"
          },
          "encoding": {
            "text": {"value": "Process Capability"}
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 30,
            "y": 55,
            "align": "left",
            "fontSize": 13,
            "fontWeight": "600",
            "color": "#555"
          },
          "encoding": {
            "text": {"value": "Cp:"}
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 160,
            "y": 55,
            "align": "right",
            "fontSize": 14,
            "fontWeight": "bold",
            "color": "#333"
          },
          "encoding": {
            "text": {"field": "cp_value", "type": "quantitative", "format": ".3f"}
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 30,
            "y": 80,
            "align": "left",
            "fontSize": 13,
            "fontWeight": "600",
            "color": "#555"
          },
          "encoding": {
            "text": {"value": "Cpk:"}
          }
        },
        {
          "mark": {
            "type": "text",
            "x": 160,
            "y": 80,
            "align": "right",
            "fontSize": 14,
            "fontWeight": "bold",
            "color": "#333"
          },
          "encoding": {
            "text": {"field": "cpk_value", "type": "quantitative", "format": ".3f"}
          }
        }
      ]
    }
  ]
}
