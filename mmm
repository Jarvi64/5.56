{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "description": "Production Floor Status Dashboard for Deneb (Power BI)",
    "data": {
        "name": "dataset"
    },
    "title": {
        "text": "ðŸ­ Production Floor Status",
        "fontSize": 20,
        "fontWeight": "bold",
        "color": "#1e293b",
        "anchor": "start",
        "offset": 20
    },
    "background": "#f8fafc",
    "padding": {
        "left": 120,
        "right": 20,
        "top": 20,
        "bottom": 20
    },
    "transform": [
        {
            "joinaggregate": [
                {
                    "op": "sum",
                    "field": "Produced",
                    "as": "Total_Produced"
                },
                {
                    "op": "sum",
                    "field": "Target",
                    "as": "Total_Target"
                },
                {
                    "op": "max",
                    "field": "Is_Down",
                    "as": "Any_Down"
                },
                {
                    "op": "sum",
                    "field": "Downtime_Mins",
                    "as": "Total_DT"
                },
                {
                    "op": "distinct",
                    "field": "Varient",
                    "as": "Variant_Count"
                },
                {
                    "op": "min",
                    "field": "Varient",
                    "as": "First_Variant"
                },
                {
                    "op": "min",
                    "field": "line_sort_order",
                    "as": "line_sort_order"
                },
                {
                    "op": "min",
                    "field": "wc_sort_order",
                    "as": "wc_sort_order"
                },
                {
                    "op": "mean",
                    "field": "OEE",
                    "as": "Avg_OEE"
                }
            ],
            "groupby": [
                "Line",
                "wc_name"
            ]
        },
        {
            "window": [
                {
                    "op": "row_number",
                    "as": "dedup_rank"
                }
            ],
            "groupby": [
                "Line",
                "wc_name"
            ]
        },
        {
            "filter": "datum.dedup_rank == 1"
        },
        {
            "window": [
                {
                    "op": "dense_rank",
                    "as": "line_rank"
                }
            ],
            "sort": [
                {
                    "field": "line_sort_order",
                    "order": "ascending"
                }
            ]
        },
        {
            "window": [
                {
                    "op": "row_number",
                    "as": "wc_rank"
                }
            ],
            "groupby": [
                "Line"
            ],
            "sort": [
                {
                    "field": "wc_sort_order",
                    "order": "ascending"
                }
            ]
        },
        {
            "calculate": "(datum.wc_rank - 1) % 5",
            "as": "col_index"
        },
        {
            "calculate": "floor((datum.wc_rank - 1) / 5)",
            "as": "row_index"
        },
        {
            "calculate": "datum.Total_Produced / datum.Total_Target",
            "as": "Achievement_Pct"
        },
        {
            "calculate": "datum.Any_Down ? 'DOWNTIME' : (!isValid(datum.Total_Produced) || (datum.Total_Produced == 0 && datum.Total_Target == 0) ? 'OFFLINE' : (datum.Total_Produced == 0 && datum.Total_Target > 0 ? 'IDLE' : 'RUNNING'))",
            "as": "Status_Text"
        },
        {
            "calculate": "datum.Any_Down ? '#ef4444' : (!isValid(datum.Total_Produced) || (datum.Total_Produced == 0 && datum.Total_Target == 0) ? '#94a3b8' : (datum.Total_Produced == 0 && datum.Total_Target > 0 ? '#f59e0b' : '#22c55e'))",
            "as": "Status_Color"
        },
        {
            "calculate": "datum.Any_Down ? '#fee2e2' : (!isValid(datum.Total_Produced) || (datum.Total_Produced == 0 && datum.Total_Target == 0) ? '#f1f5f9' : (datum.Total_Produced == 0 && datum.Total_Target > 0 ? '#fef3c7' : '#dcfce7'))",
            "as": "Pill_BG"
        },
        {
            "calculate": "datum.Any_Down ? '#991b1b' : (!isValid(datum.Total_Produced) || (datum.Total_Produced == 0 && datum.Total_Target == 0) ? '#64748b' : (datum.Total_Produced == 0 && datum.Total_Target > 0 ? '#92400e' : '#166534'))",
            "as": "Pill_Text_Color"
        },
        {
            "calculate": "!isValid(datum.Total_Produced) || (datum.Total_Produced == 0 && datum.Total_Target == 0) ? '-' : (datum.Total_Produced >= 1000000 ? format(datum.Total_Produced/1000000, '.1f') + 'M' : (datum.Total_Produced >= 1000 ? format(datum.Total_Produced/1000, '.1f') + 'K' : datum.Total_Produced))",
            "as": "Produced_Formatted"
        },
        {
            "calculate": "(isValid(datum.Total_Target) ? format(datum.Total_Target, ',d') : '-') + ' Tgt'",
            "as": "Target_Label"
        },
        {
            "calculate": "datum.Total_DT > 0 ? (datum.Total_DT > 60 ? 'DT: ' + format(datum.Total_DT / 60, '.1f') + 'h' : 'DT: ' + datum.Total_DT + 'm') : ''",
            "as": "Downtime_Label"
        },
        {
            "calculate": "isValid(datum.Avg_OEE) ? 'OEE ' + format(datum.Avg_OEE, '.0%') : ''",
            "as": "OEE_Label"
        },
        {
            "calculate": "isValid(datum.Total_Target) && isValid(datum.Total_Produced) ? max(0, datum.Total_Target - datum.Total_Produced) : 0",
            "as": "Remaining_Qty"
        },
        {
            "calculate": "datum.Total_Target > 0 ? (datum.Remaining_Qty / datum.Total_Target) : 0",
            "as": "Remaining_Pct"
        },
        {
            "calculate": "datum.Total_Target > 0 && isValid(datum.Total_Produced) ? abs(datum.Total_Produced - datum.Total_Target) / datum.Total_Target : 0",
            "as": "Variance_Pct"
        },
        {
            "calculate": "abs(datum.Total_Produced - datum.Total_Target) >= 1000000 ? format(abs(datum.Total_Produced - datum.Total_Target)/1000000, '.1f') + 'M' : (abs(datum.Total_Produced - datum.Total_Target) >= 1000 ? format(abs(datum.Total_Produced - datum.Total_Target)/1000, '.1f') + 'K' : abs(datum.Total_Produced - datum.Total_Target))",
            "as": "Variance_Formatted"
        },
        {
            "calculate": "!isValid(datum.Total_Target) || !isValid(datum.Total_Produced) ? '' : (datum.Total_Target == 0 && datum.Total_Produced == 0 ? '' : (datum.Total_Produced >= datum.Total_Target ? (datum.Total_Produced > datum.Total_Target ? 'Ahead by ' + datum.Variance_Formatted + ' (' + format(datum.Variance_Pct, '.0%') + ')' : 'On Target') : ('Behind by ' + datum.Variance_Formatted + ' (' + format(datum.Variance_Pct, '.0%') + ')')))",
            "as": "Remaining_Label"
        },
        {
            "calculate": "!isValid(datum.Total_Target) || !isValid(datum.Total_Produced) || (datum.Total_Target == 0 && datum.Total_Produced == 0) ? '#94a3b8' : (datum.Total_Produced >= datum.Total_Target ? '#22c55e' : '#ef4444')",
            "as": "Remaining_Color"
        },
        {
            "calculate": "datum.Variant_Count > 1 ? datum.First_Variant + ' +' + (datum.Variant_Count - 1) : (isValid(datum.First_Variant) ? datum.First_Variant : '')",
            "as": "Variant_Label"
        },
        {
            "calculate": "isValid(datum.Avg_OEE) ? datum.Avg_OEE : 0",
            "as": "OEE_Safe"
        },
        {
            "calculate": "datum.OEE_Safe >= 0.9 ? '#22c55e' : (datum.OEE_Safe >= 0.75 ? '#f59e0b' : '#ef4444')",
            "as": "OEE_Color"
        },
        {
            "calculate": "datum.Achievement_Pct >= 1 ? '#22c55e' : (datum.Achievement_Pct >= 0.9 ? '#f59e0b' : '#ef4444')",
            "as": "Progress_Color"
        }
    ],
    "facet": {
        "row": {
            "field": "Line",
            "type": "nominal",
            "title": null,
            "sort": {
                "field": "line_sort_order",
                "order": "ascending"
            },
            "header": {
                "labels": false,
                "title": null
            }
        }
    },
    "resolve": {
        "scale": {
            "y": "independent"
        }
    },
    "spec": {
        "width": {
            "step": 230
        },
        "height": {
            "step": 150
        },
        "layer": [
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "middle",
                    "dx": -25,
                    "fontSize": 16,
                    "fontWeight": "bold",
                    "color": "#64748b"
                },
                "encoding": {
                    "text": {
                        "field": "Line"
                    },
                    "x": {
                        "value": 0
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal",
                        "axis": null
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.wc_rank == 1",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "cornerRadius": 16,
                    "fill": "white",
                    "stroke": "#e2e8f0",
                    "strokeWidth": 1.5,
                    "width": 220,
                    "height": 130,
                    "cursor": "pointer",
                    "opacity": 0.98
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal",
                        "axis": null,
                        "scale": {
                            "step": 230
                        }
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal",
                        "axis": null,
                        "scale": {
                            "step": 150
                        }
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "width": 218,
                    "height": 128,
                    "cornerRadius": 16,
                    "fill": "#fee2e2",
                    "opacity": 0.7
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Any_Down",
                            "value": 0.6
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "width": 218,
                    "height": 128,
                    "cornerRadius": 16,
                    "fill": "#e2e8f0",
                    "opacity": 0.85
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Status_Text == 'OFFLINE'",
                            "value": 0.85
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "width": 218,
                    "height": 128,
                    "cornerRadius": 16,
                    "fill": "#fef3c7",
                    "opacity": 0.5
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Status_Text == 'IDLE'",
                            "value": 0.5
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "width": 6,
                    "height": 130,
                    "cornerRadiusTopLeft": 16,
                    "cornerRadiusBottomLeft": 16,
                    "xOffset": -107
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "color": {
                        "field": "Status_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "top",
                    "dx": -95,
                    "dy": -53,
                    "fontSize": 14,
                    "fontWeight": 700,
                    "color": "#1e293b",
                    "font": "Inter"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "wc_name"
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "top",
                    "dx": -95,
                    "dy": -36,
                    "fontSize": 11,
                    "fontWeight": 500,
                    "color": "#64748b",
                    "font": "Inter"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Variant_Label"
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Variant_Label != ''",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "rect",
                    "cornerRadius": 100,
                    "height": 20,
                    "width": 80,
                    "xOffset": 65,
                    "yOffset": -50
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "color": {
                        "field": "Pill_BG",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "center",
                    "baseline": "middle",
                    "dx": 65,
                    "dy": -49,
                    "fontSize": 9,
                    "fontWeight": 700,
                    "font": "Inter",
                    "letterSpacing": 0.5
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Status_Text"
                    },
                    "color": {
                        "field": "Pill_Text_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "middle",
                    "dx": -95,
                    "dy": 0,
                    "fontSize": 32,
                    "fontWeight": 800,
                    "font": "Inter"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Produced_Formatted"
                    },
                    "color": {
                        "field": "Status_Color",
                        "scale": null
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "left",
                    "baseline": "bottom",
                    "dx": -95,
                    "dy": 53,
                    "fontSize": 11,
                    "fontWeight": 600,
                    "color": "#475569",
                    "font": "Inter"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "OEE_Label"
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Status_Text == 'OFFLINE'",
                            "value": 0
                        },
                        "value": 1
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 35,
                    "fontSize": 13,
                    "fontWeight": 600,
                    "color": "#64748b",
                    "font": "Inter"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Target_Label"
                    },
                    "opacity": {
                        "condition": {
                            "test": "!isValid(datum.Total_Target)",
                            "value": 0
                        },
                        "value": 1
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "bottom",
                    "dx": 105,
                    "dy": 53,
                    "fontSize": 11,
                    "fontWeight": 700,
                    "font": "Inter"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Remaining_Label"
                    },
                    "color": {
                        "field": "Remaining_Color",
                        "scale": null
                    },
                    "opacity": {
                        "condition": {
                            "test": "datum.Remaining_Label != ''",
                            "value": 1
                        },
                        "value": 0
                    }
                }
            },
            {
                "mark": {
                    "type": "text",
                    "align": "right",
                    "baseline": "top",
                    "dx": 105,
                    "dy": -24,
                    "fontSize": 12,
                    "fontWeight": 700,
                    "color": "#dc2626",
                    "font": "Inter"
                },
                "encoding": {
                    "x": {
                        "field": "col_index",
                        "type": "ordinal"
                    },
                    "y": {
                        "field": "row_index",
                        "type": "ordinal"
                    },
                    "text": {
                        "field": "Downtime_Label"
                    }
                }
            }
        ]
    },
    "config": {
        "view": {
            "stroke": null
        },
        "facet": {
            "spacing": 20
        },
        "axis": {
            "grid": false
        }
    }
}
