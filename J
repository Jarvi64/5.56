{
  "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
  "description": "Process Capability Histogram with Control Limits",
  "autosize": {
    "type": "fit",
    "contains": "padding"
  },
  "width": "container",
  "height": "container",
  "data": {"name": "dataset"},
  "layer": [
    {
      "mark": {
        "type": "bar",
        "color": "#4682B4",
        "opacity": 0.7
      },
      "encoding": {
        "x": {
          "bin": {"maxbins": 30},
          "field": "measuredvalue",
          "type": "quantitative",
          "title": "Measured Value"
        },
        "y": {
          "aggregate": "count",
          "type": "quantitative",
          "title": "Frequency"
        },
        "tooltip": [
          {"bin": true, "field": "measuredvalue", "type": "quantitative", "title": "Range"},
          {"aggregate": "count", "type": "quantitative", "title": "Frequency"}
        ]
      }
    },
    {
      "data": {"name": "dataset"},
      "transform": [
        {
          "aggregate": [
            {"op": "mean", "field": "measuredvalue", "as": "xbar"},
            {"op": "max", "field": "measuredvalue", "as": "max_val"},
            {"op": "min", "field": "measuredvalue", "as": "min_val"}
          ],
          "groupby": ["lot_breaker_id"]
        },
        {
          "calculate": "datum.max_val - datum.min_val",
          "as": "range"
        },
        {
          "joinaggregate": [
            {"op": "mean", "field": "xbar", "as": "grandxbar"},
            {"op": "mean", "field": "range", "as": "rbar"},
            {"op": "count", "as": "num_subgroups"}
          ]
        },
        {
          "calculate": "1",
          "as": "dummy"
        }
      ],
      "layer": [
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "overall_mean"},
                {"op": "stdev", "field": "measuredvalue", "as": "stdev"},
                {"op": "count", "as": "total_count"}
              ]
            },
            {
              "calculate": "1",
              "as": "dummy"
            }
          ],
          "layer": [
            {
              "data": {"name": "dataset"},
              "transform": [
                {
                  "aggregate": [
                    {"op": "mean", "field": "measuredvalue", "as": "xbar"},
                    {"op": "max", "field": "measuredvalue", "as": "max_val"},
                    {"op": "min", "field": "measuredvalue", "as": "min_val"}
                  ],
                  "groupby": ["lot_breaker_id"]
                },
                {
                  "calculate": "datum.max_val - datum.min_val",
                  "as": "range"
                },
                {
                  "joinaggregate": [
                    {"op": "mean", "field": "xbar", "as": "grandxbar"},
                    {"op": "mean", "field": "range", "as": "rbar"}
                  ]
                },
                {
                  "calculate": "1",
                  "as": "dummy"
                }
              ],
              "layer": [
                {
                  "data": {"name": "dataset"},
                  "transform": [
                    {
                      "aggregate": [
                        {"op": "mean", "field": "measuredvalue", "as": "overall_mean"},
                        {"op": "stdev", "field": "measuredvalue", "as": "stdev"},
                        {"op": "count", "as": "total_count"}
                      ]
                    },
                    {"calculate": "datum.overall_mean - 4 * datum.stdev", "as": "x_min"},
                    {"calculate": "datum.overall_mean + 4 * datum.stdev", "as": "x_max"},
                    {"calculate": "sequence(datum.x_min, datum.x_max, (datum.x_max - datum.x_min) / 100)", "as": "x_seq"},
            {"flatten": ["x_seq"]},
            {"calculate": "datum.x_seq", "as": "x"},
            {
              "calculate": "(1 / (datum.stdev * sqrt(2 * PI))) * exp(-0.5 * pow((datum.x - datum.overall_mean) / datum.stdev, 2))",
              "as": "density"
            },
            {
              "calculate": "datum.density * datum.total_count * ((datum.x_max - datum.x_min) / 25)",
              "as": "y"
            }
          ],
          "mark": {
            "type": "line",
            "color": "#e74c3c",
            "strokeWidth": 3
          },
          "encoding": {
            "x": {
              "field": "x",
              "type": "quantitative"
            },
            "y": {
              "field": "y",
              "type": "quantitative"
            }
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"}
              ]
            },
            {
              "aggregate": [
                {"op": "max", "field": "grandxbar", "as": "mean_val"}
              ]
            }
          ],
          "mark": {
            "type": "rule",
            "strokeDash": [6, 4],
            "color": "#27ae60",
            "strokeWidth": 2.5
          },
          "encoding": {
            "x": {
              "field": "mean_val",
              "type": "quantitative"
            }
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"}
              ]
            },
            {
              "aggregate": [
                {"op": "max", "field": "grandxbar", "as": "mean_val"}
              ]
            }
          ],
          "mark": {
            "type": "text",
            "dy": -35,
            "fontSize": 10,
            "fontWeight": "600",
            "color": "#27ae60"
          },
          "encoding": {
            "x": {
              "field": "mean_val",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"value": "X̄̄"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"}
              ]
            },
            {
              "aggregate": [
                {"op": "max", "field": "grandxbar", "as": "mean_val"}
              ]
            }
          ],
          "mark": {
            "type": "text",
            "dy": -20,
            "fontSize": 11,
            "fontWeight": "bold",
            "color": "#27ae60"
          },
          "encoding": {
            "x": {
              "field": "mean_val",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"field": "mean_val", "type": "quantitative", "format": ".3f"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {"aggregate": [{"op": "max", "field": "lowerlimit", "as": "lsl_value"}]}
          ],
          "mark": {
            "type": "rule",
            "strokeDash": [5, 5],
            "color": "#c0392b",
            "strokeWidth": 2.5
          },
          "encoding": {
            "x": {
              "field": "lsl_value",
              "type": "quantitative"
            }
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {"aggregate": [{"op": "max", "field": "lowerlimit", "as": "lsl_value"}]}
          ],
          "mark": {
            "type": "text",
            "dy": -35,
            "fontSize": 10,
            "fontWeight": "600",
            "color": "#c0392b",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "lsl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"value": "LSL"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {"aggregate": [{"op": "max", "field": "lowerlimit", "as": "lsl_value"}]}
          ],
          "mark": {
            "type": "text",
            "dy": -20,
            "fontSize": 11,
            "fontWeight": "bold",
            "color": "#c0392b",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "lsl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"field": "lsl_value", "type": "quantitative", "format": ".3f"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {"aggregate": [{"op": "max", "field": "upperlimit", "as": "usl_value"}]}
          ],
          "mark": {
            "type": "rule",
            "strokeDash": [5, 5],
            "color": "#c0392b",
            "strokeWidth": 2.5
          },
          "encoding": {
            "x": {
              "field": "usl_value",
              "type": "quantitative"
            }
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {"aggregate": [{"op": "max", "field": "upperlimit", "as": "usl_value"}]}
          ],
          "mark": {
            "type": "text",
            "dy": -35,
            "fontSize": 10,
            "fontWeight": "600",
            "color": "#c0392b",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "usl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"value": "USL"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {"aggregate": [{"op": "max", "field": "upperlimit", "as": "usl_value"}]}
          ],
          "mark": {
            "type": "text",
            "dy": -20,
            "fontSize": 11,
            "fontWeight": "bold",
            "color": "#c0392b",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "usl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"field": "usl_value", "type": "quantitative", "format": ".3f"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"},
                {"op": "max", "field": "measuredvalue", "as": "max_val"},
                {"op": "min", "field": "measuredvalue", "as": "min_val"},
                {"op": "max", "field": "sampleqty", "as": "n"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "calculate": "datum.max_val - datum.min_val",
              "as": "range"
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"},
                {"op": "mean", "field": "range", "as": "rbar"}
              ]
            },
            {
              "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
              "as": "a2"
            },
            {
              "calculate": "datum.grandxbar + (datum.a2 * datum.rbar)",
              "as": "ucl"
            },
            {
              "aggregate": [
                {"op": "max", "field": "ucl", "as": "ucl_value"}
              ]
            }
          ],
          "mark": {
            "type": "rule",
            "strokeDash": [8, 4],
            "color": "#e67e22",
            "strokeWidth": 2.5
          },
          "encoding": {
            "x": {
              "field": "ucl_value",
              "type": "quantitative"
            }
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"},
                {"op": "max", "field": "measuredvalue", "as": "max_val"},
                {"op": "min", "field": "measuredvalue", "as": "min_val"},
                {"op": "max", "field": "sampleqty", "as": "n"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "calculate": "datum.max_val - datum.min_val",
              "as": "range"
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"},
                {"op": "mean", "field": "range", "as": "rbar"}
              ]
            },
            {
              "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
              "as": "a2"
            },
            {
              "calculate": "datum.grandxbar + (datum.a2 * datum.rbar)",
              "as": "ucl"
            },
            {
              "aggregate": [
                {"op": "max", "field": "ucl", "as": "ucl_value"}
              ]
            }
          ],
          "mark": {
            "type": "text",
            "dy": -35,
            "fontSize": 10,
            "fontWeight": "600",
            "color": "#e67e22",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "ucl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"value": "UCL"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"},
                {"op": "max", "field": "measuredvalue", "as": "max_val"},
                {"op": "min", "field": "measuredvalue", "as": "min_val"},
                {"op": "max", "field": "sampleqty", "as": "n"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "calculate": "datum.max_val - datum.min_val",
              "as": "range"
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"},
                {"op": "mean", "field": "range", "as": "rbar"}
              ]
            },
            {
              "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
              "as": "a2"
            },
            {
              "calculate": "datum.grandxbar + (datum.a2 * datum.rbar)",
              "as": "ucl"
            },
            {
              "aggregate": [
                {"op": "max", "field": "ucl", "as": "ucl_value"}
              ]
            }
          ],
          "mark": {
            "type": "text",
            "dy": -20,
            "fontSize": 11,
            "fontWeight": "bold",
            "color": "#e67e22",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "ucl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"field": "ucl_value", "type": "quantitative", "format": ".3f"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"},
                {"op": "max", "field": "measuredvalue", "as": "max_val"},
                {"op": "min", "field": "measuredvalue", "as": "min_val"},
                {"op": "max", "field": "sampleqty", "as": "n"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "calculate": "datum.max_val - datum.min_val",
              "as": "range"
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"},
                {"op": "mean", "field": "range", "as": "rbar"}
              ]
            },
            {
              "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
              "as": "a2"
            },
            {
              "calculate": "datum.grandxbar - (datum.a2 * datum.rbar)",
              "as": "lcl"
            },
            {
              "aggregate": [
                {"op": "max", "field": "lcl", "as": "lcl_value"}
              ]
            }
          ],
          "mark": {
            "type": "rule",
            "strokeDash": [8, 4],
            "color": "#e67e22",
            "strokeWidth": 2.5
          },
          "encoding": {
            "x": {
              "field": "lcl_value",
              "type": "quantitative"
            }
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
                {"op": "mean", "field": "measuredvalue", "as": "xbar"},
                {"op": "max", "field": "measuredvalue", "as": "max_val"},
                {"op": "min", "field": "measuredvalue", "as": "min_val"},
                {"op": "max", "field": "sampleqty", "as": "n"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "calculate": "datum.max_val - datum.min_val",
              "as": "range"
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"},
                {"op": "mean", "field": "range", "as": "rbar"}
              ]
            },
            {
              "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
              "as": "a2"
            },
            {
              "calculate": "datum.grandxbar - (datum.a2 * datum.rbar)",
              "as": "lcl"
            },
            {
              "aggregate": [
                {"op": "max", "field": "lcl", "as": "lcl_value"}
              ]
            }
          ],
          "mark": {
            "type": "text",
            "dy": -35,
            "fontSize": 10,
            "fontWeight": "600",
            "color": "#e67e22",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "lcl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"value": "LCL"}
          }
        },
        {
          "data": {"name": "dataset"},
          "transform": [
            {
              "aggregate": [
{"op": "mean", "field": "measuredvalue", "as": "xbar"},
                {"op": "max", "field": "measuredvalue", "as": "max_val"},
                {"op": "min", "field": "measuredvalue", "as": "min_val"},
                {"op": "max", "field": "sampleqty", "as": "n"}
              ],
              "groupby": ["lot_breaker_id"]
            },
            {
              "calculate": "datum.max_val - datum.min_val",
              "as": "range"
            },
            {
              "joinaggregate": [
                {"op": "mean", "field": "xbar", "as": "grandxbar"},
                {"op": "mean", "field": "range", "as": "rbar"}
              ]
            },
            {
              "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
              "as": "a2"
            },
            {
              "calculate": "datum.grandxbar - (datum.a2 * datum.rbar)",
              "as": "lcl"
            },
            {
              "aggregate": [
                {"op": "max", "field": "lcl", "as": "lcl_value"}
              ]
            }
          ],
          "mark": {
            "type": "text",
            "dy": -20,
            "fontSize": 11,
            "fontWeight": "bold",
            "color": "#e67e22",
            "align": "center"
          },
          "encoding": {
            "x": {
              "field": "lcl_value",
              "type": "quantitative"
            },
            "y": {"value": 0},
            "text": {"field": "lcl_value", "type": "quantitative", "format": ".3f"}
          }
        }
      ]
    }
  ]
}
