{
    "$schema": "https://vega.github.io/schema/vega-lite/v5.json",
    "background": "#ffffff",
    "padding": 8,
    "data": {
        "name": "dataset"
    },
    "hconcat": [
        {
            "width": 300,
            "height": 630,
            "layer": [
                // Main card background
                {
                    "mark": {
                        "type": "rect",
                        "fill": "#f8fafc",
                        "stroke": "#cbd5e1",
                        "strokeWidth": 1,
                        "cornerRadius": 12
                    },
                    "encoding": {
                        "x": {
                            "value": 0
                        },
                        "x2": {
                            "value": 300
                        },
                        "y": {
                            "value": 0
                        },
                        "y2": {
                            "value": 630
                        }
                    }
                },
                // Stats calculations
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "measuredvalue",
                                    "as": "xbar"
                                },
                                {
                                    "op": "max",
                                    "field": "measuredvalue",
                                    "as": "max_val"
                                },
                                {
                                    "op": "min",
                                    "field": "measuredvalue",
                                    "as": "min_val"
                                },
                                {
                                    "op": "max",
                                    "field": "sampleqty",
                                    "as": "n"
                                },
                                {
                                    "op": "max",
                                    "field": "upperlimit",
                                    "as": "usl"
                                },
                                {
                                    "op": "max",
                                    "field": "lowerlimit",
                                    "as": "lsl"
                                },
                                {
                                    "op": "max",
                                    "field": "nominallimit",
                                    "as": "nominal"
                                },
                                {
                                    "op": "count",
                                    "as": "samples_in_lot"
                                }
                            ],
                            "groupby": [
                                "lot_breaker_id"
                            ]
                        },
                        {
                            "calculate": "datum.max_val - datum.min_val",
                            "as": "range"
                        },
                        {
                            "joinaggregate": [
                                {
                                    "op": "mean",
                                    "field": "xbar",
                                    "as": "grandxbar"
                                },
                                {
                                    "op": "mean",
                                    "field": "range",
                                    "as": "rbar"
                                },
                                {
                                    "op": "count",
                                    "as": "num_lots"
                                },
                                {
                                    "op": "sum",
                                    "field": "samples_in_lot",
                                    "as": "total_samples"
                                },
                                {
                                    "op": "max",
                                    "field": "max_val",
                                    "as": "overall_max"
                                },
                                {
                                    "op": "min",
                                    "field": "min_val",
                                    "as": "overall_min"
                                }
                            ]
                        },
                        {
                            "calculate": "datum.n == 2 ? 1.128 : datum.n == 3 ? 1.693 : datum.n == 4 ? 2.059 : datum.n == 5 ? 2.326 : datum.n == 6 ? 2.534 : datum.n == 7 ? 2.704 : datum.n == 8 ? 2.847 : datum.n == 9 ? 2.970 : datum.n == 10 ? 3.078 : 2.326",
                            "as": "d2"
                        },
                        {
                            "calculate": "datum.rbar / datum.d2",
                            "as": "sigma"
                        },
                        {
                            "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
                            "as": "a2"
                        },
                        {
                            "calculate": "datum.grandxbar + (datum.a2 * datum.rbar)",
                            "as": "ucl"
                        },
                        {
                            "calculate": "datum.grandxbar - (datum.a2 * datum.rbar)",
                            "as": "lcl"
                        },
                        {
                            "calculate": "datum.grandxbar + (3 * datum.sigma)",
                            "as": "plus3sigma"
                        },
                        {
                            "calculate": "datum.grandxbar - (3 * datum.sigma)",
                            "as": "minus3sigma"
                        },
                        {
                            "calculate": "(datum.usl - datum.lsl) / (6 * datum.sigma)",
                            "as": "cp"
                        },
                        {
                            "calculate": "min((datum.usl - datum.grandxbar) / (3 * datum.sigma), (datum.grandxbar - datum.lsl) / (3 * datum.sigma))",
                            "as": "cpk"
                        },
                        {
                            "aggregate": [
                                {
                                    "op": "max",
                                    "field": "n",
                                    "as": "n"
                                },
                                {
                                    "op": "max",
                                    "field": "total_samples",
                                    "as": "total"
                                },
                                {
                                    "op": "max",
                                    "field": "num_lots",
                                    "as": "lots"
                                },
                                {
                                    "op": "max",
                                    "field": "overall_max",
                                    "as": "max"
                                },
                                {
                                    "op": "max",
                                    "field": "overall_min",
                                    "as": "min"
                                },
                                {
                                    "op": "max",
                                    "field": "grandxbar",
                                    "as": "mean"
                                },
                                {
                                    "op": "max",
                                    "field": "sigma",
                                    "as": "sigma"
                                },
                                {
                                    "op": "max",
                                    "field": "lsl",
                                    "as": "lsl"
                                },
                                {
                                    "op": "max",
                                    "field": "usl",
                                    "as": "usl"
                                },
                                {
                                    "op": "max",
                                    "field": "nominal",
                                    "as": "nominal"
                                },
                                {
                                    "op": "max",
                                    "field": "lcl",
                                    "as": "lcl"
                                },
                                {
                                    "op": "max",
                                    "field": "ucl",
                                    "as": "ucl"
                                },
                                {
                                    "op": "max",
                                    "field": "plus3sigma",
                                    "as": "plus3sigma"
                                },
                                {
                                    "op": "max",
                                    "field": "minus3sigma",
                                    "as": "minus3sigma"
                                },
                                {
                                    "op": "max",
                                    "field": "cp",
                                    "as": "cp"
                                },
                                {
                                    "op": "max",
                                    "field": "cpk",
                                    "as": "cpk"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        // ===== SECTION 1: Basic Statistics =====
                        {
                            "mark": {
                                "type": "rect",
                                "fill": "#1e40af",
                                "cornerRadiusTopLeft": 12,
                                "cornerRadiusTopRight": 12
                            },
                            "encoding": {
                                "x": {
                                    "value": 0
                                },
                                "x2": {
                                    "value": 300
                                },
                                "y": {
                                    "value": 0
                                },
                                "y2": {
                                    "value": 32
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#ffffff",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 20
                                },
                                "text": {
                                    "value": "Basic Statistics"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 52
                                },
                                "text": {
                                    "value": "Sample Size (n)"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 52
                                },
                                "text": {
                                    "field": "n"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 72
                                },
                                "text": {
                                    "value": "Total Samples"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 72
                                },
                                "text": {
                                    "field": "total"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 92
                                },
                                "text": {
                                    "value": "No. of Lots"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 92
                                },
                                "text": {
                                    "field": "lots"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 112
                                },
                                "text": {
                                    "value": "Maximum"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 112
                                },
                                "text": {
                                    "field": "max",
                                    "format": ".4f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 132
                                },
                                "text": {
                                    "value": "Minimum"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 132
                                },
                                "text": {
                                    "field": "min",
                                    "format": ".4f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 152
                                },
                                "text": {
                                    "value": "Mean (X̄̄)"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 152
                                },
                                "text": {
                                    "field": "mean",
                                    "format": ".4f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 172
                                },
                                "text": {
                                    "value": "Sigma (σ = R̄/d₂)"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 172
                                },
                                "text": {
                                    "field": "sigma",
                                    "format": ".5f"
                                }
                            }
                        },
                        // ===== SECTION 2: Specification Limits =====
                        {
                            "mark": {
                                "type": "rect",
                                "fill": "#dc2626"
                            },
                            "encoding": {
                                "x": {
                                    "value": 0
                                },
                                "x2": {
                                    "value": 300
                                },
                                "y": {
                                    "value": 190
                                },
                                "y2": {
                                    "value": 222
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#ffffff",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 210
                                },
                                "text": {
                                    "value": "Specification Limits"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 244
                                },
                                "text": {
                                    "value": "USL"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#dc2626",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 244
                                },
                                "text": {
                                    "field": "usl",
                                    "format": ".3f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 264
                                },
                                "text": {
                                    "value": "Nominal"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#7c3aed",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 264
                                },
                                "text": {
                                    "field": "nominal",
                                    "format": ".3f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 284
                                },
                                "text": {
                                    "value": "LSL"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#dc2626",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 284
                                },
                                "text": {
                                    "field": "lsl",
                                    "format": ".3f"
                                }
                            }
                        },
                        // ===== SECTION 3: Control Limits =====
                        {
                            "mark": {
                                "type": "rect",
                                "fill": "#ea580c"
                            },
                            "encoding": {
                                "x": {
                                    "value": 0
                                },
                                "x2": {
                                    "value": 300
                                },
                                "y": {
                                    "value": 302
                                },
                                "y2": {
                                    "value": 334
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#ffffff",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 322
                                },
                                "text": {
                                    "value": "Control Limits"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 356
                                },
                                "text": {
                                    "value": "UCL = X̄̄ + A₂R̄"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#ea580c",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 356
                                },
                                "text": {
                                    "field": "ucl",
                                    "format": ".4f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 376
                                },
                                "text": {
                                    "value": "LCL = X̄̄ - A₂R̄"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#ea580c",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 376
                                },
                                "text": {
                                    "field": "lcl",
                                    "format": ".4f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 396
                                },
                                "text": {
                                    "value": "+3σ / -3σ"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0d9488",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 396
                                },
                                "text": {
                                    "field": "plus3sigma",
                                    "format": ".4f"
                                }
                            }
                        },
                        // ===== SECTION 4: Out of Spec =====
                        {
                            "mark": {
                                "type": "rect",
                                "fill": "#7c3aed"
                            },
                            "encoding": {
                                "x": {
                                    "value": 0
                                },
                                "x2": {
                                    "value": 300
                                },
                                "y": {
                                    "value": 414
                                },
                                "y2": {
                                    "value": 446
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#ffffff",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 434
                                },
                                "text": {
                                    "value": "Out of Spec"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 466
                                },
                                "text": {
                                    "value": "Above USL"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 486
                                },
                                "text": {
                                    "value": "Below LSL"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 506
                                },
                                "text": {
                                    "value": "Total"
                                }
                            }
                        },
                        // ===== SECTION 5: Capability Indices =====
                        {
                            "mark": {
                                "type": "rect",
                                "fill": "#16a34a"
                            },
                            "encoding": {
                                "x": {
                                    "value": 0
                                },
                                "x2": {
                                    "value": 300
                                },
                                "y": {
                                    "value": 524
                                },
                                "y2": {
                                    "value": 556
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#ffffff",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 544
                                },
                                "text": {
                                    "value": "Capability Indices"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 578
                                },
                                "text": {
                                    "value": "Cp = (USL-LSL)/6σ"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#16a34a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 578
                                },
                                "text": {
                                    "field": "cp",
                                    "format": ".2f"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "color": "#475569",
                                "align": "left"
                            },
                            "encoding": {
                                "x": {
                                    "value": 14
                                },
                                "y": {
                                    "value": 604
                                },
                                "text": {
                                    "value": "Cpk = min(Cpu, Cpl)"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#16a34a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 604
                                },
                                "text": {
                                    "field": "cpk",
                                    "format": ".2f"
                                }
                            }
                        },
                        // Status Badge (Inside Header) - White background, dynamic text
                        {
                            "transform": [
                                {
                                    "calculate": "datum.cpk >= 1.33 ? 'CAPABLE' : datum.cpk >= 1.0 ? 'MARGINAL' : 'NOT CAPABLE'",
                                    "as": "status"
                                },
                                {
                                    "calculate": "datum.cpk >= 1.33 ? '#065f46' : datum.cpk >= 1.0 ? '#d97706' : '#dc2626'",
                                    "as": "status_color"
                                }
                            ],
                            "layer": [
                                {
                                    "mark": {
                                        "type": "rect",
                                        "cornerRadius": 4,
                                        "fill": "#ffffff"
                                    },
                                    "encoding": {
                                        "x": {
                                            "value": 190
                                        },
                                        "x2": {
                                            "value": 286
                                        },
                                        "y": {
                                            "value": 532
                                        },
                                        "y2": {
                                            "value": 550
                                        }
                                    }
                                },
                                {
                                    "mark": {
                                        "type": "text",
                                        "fontSize": 10,
                                        "fontWeight": "bold",
                                        "align": "center"
                                    },
                                    "encoding": {
                                        "x": {
                                            "value": 238
                                        },
                                        "y": {
                                            "value": 542
                                        },
                                        "text": {
                                            "field": "status"
                                        },
                                        "color": {
                                            "field": "status_color",
                                            "type": "nominal",
                                            "scale": null
                                        }
                                    }
                                }
                            ]
                        }
                    ]
                },
                // Out of Spec Calculations & Values (Inside Table)
                {
                    "transform": [
                        {
                            "joinaggregate": [
                                {
                                    "op": "max",
                                    "field": "upperlimit",
                                    "as": "usl"
                                },
                                {
                                    "op": "max",
                                    "field": "lowerlimit",
                                    "as": "lsl"
                                },
                                {
                                    "op": "count",
                                    "as": "total_count"
                                }
                            ]
                        },
                        {
                            "calculate": "datum.measuredvalue > datum.usl ? 1 : 0",
                            "as": "above"
                        },
                        {
                            "calculate": "datum.measuredvalue < datum.lsl ? 1 : 0",
                            "as": "below"
                        },
                        {
                            "aggregate": [
                                {
                                    "op": "sum",
                                    "field": "above",
                                    "as": "above_count"
                                },
                                {
                                    "op": "sum",
                                    "field": "below",
                                    "as": "below_count"
                                },
                                {
                                    "op": "max",
                                    "field": "total_count",
                                    "as": "total"
                                }
                            ]
                        },
                        {
                            "calculate": "(datum.above_count / datum.total) * 100",
                            "as": "above_pct"
                        },
                        {
                            "calculate": "(datum.below_count / datum.total) * 100",
                            "as": "below_pct"
                        },
                        {
                            "calculate": "((datum.above_count + datum.below_count) / datum.total) * 100",
                            "as": "total_pct"
                        },
                        {
                            "calculate": "format(datum.above_pct, '.1f') + '%'",
                            "as": "above_pct_str"
                        },
                        {
                            "calculate": "format(datum.below_pct, '.1f') + '%'",
                            "as": "below_pct_str"
                        },
                        {
                            "calculate": "format(datum.total_pct, '.1f') + '%'",
                            "as": "total_pct_str"
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 466
                                },
                                "text": {
                                    "field": "above_pct_str"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 486
                                },
                                "text": {
                                    "field": "below_pct_str"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "600",
                                "color": "#0f172a",
                                "align": "right"
                            },
                            "encoding": {
                                "x": {
                                    "value": 286
                                },
                                "y": {
                                    "value": 506
                                },
                                "text": {
                                    "field": "total_pct_str"
                                }
                            }
                        }
                    ]
                }
            ]
        },
        {
            "width": 660,
            "height": 630,
            "layer": [
                {
                    "mark": {
                        "type": "bar",
                        "cornerRadiusTopLeft": 3,
                        "cornerRadiusTopRight": 3
                    },
                    "encoding": {
                        "x": {
                            "bin": {
                                "maxbins": 18
                            },
                            "field": "measuredvalue",
                            "type": "quantitative",
                            "title": "Measured Value",
                            "axis": {
                                "labelFontSize": 13,
                                "titleFontSize": 15,
                                "titleFontWeight": 700,
                                "labelAngle": -45,
                                "format": ".2f",
                                "grid": false,
                                "domainWidth": 2,
                                "domainColor": "#1e293b",
                                "tickColor": "#1e293b"
                            }
                        },
                        "y": {
                            "aggregate": "count",
                            "type": "quantitative",
                            "title": "Frequency",
                            "axis": {
                                "labelFontSize": 13,
                                "titleFontSize": 15,
                                "titleFontWeight": 700,
                                "grid": true,
                                "gridOpacity": 0.15,
                                "domainWidth": 2,
                                "domainColor": "#1e293b",
                                "tickColor": "#1e293b"
                            }
                        },
                        "color": {
                            "value": "#60a5fa"
                        },
                        "stroke": {
                            "value": "#1e3a8a"
                        },
                        "strokeWidth": {
                            "value": 1
                        },
                        "tooltip": [
                            {
                                "bin": true,
                                "field": "measuredvalue",
                                "type": "quantitative",
                                "title": "Range",
                                "format": ".4f"
                            },
                            {
                                "aggregate": "count",
                                "type": "quantitative",
                                "title": "Frequency"
                            }
                        ]
                    }
                },
                // Gaussian Curve
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "measuredvalue",
                                    "as": "mean"
                                },
                                {
                                    "op": "stdev",
                                    "field": "measuredvalue",
                                    "as": "stdev"
                                },
                                {
                                    "op": "count",
                                    "as": "total_count"
                                },
                                {
                                    "op": "min",
                                    "field": "measuredvalue",
                                    "as": "data_min"
                                },
                                {
                                    "op": "max",
                                    "field": "measuredvalue",
                                    "as": "data_max"
                                }
                            ]
                        },
                        {
                            "calculate": "datum.mean - 4 * datum.stdev",
                            "as": "x_min"
                        },
                        {
                            "calculate": "datum.mean + 4 * datum.stdev",
                            "as": "x_max"
                        },
                        {
                            "calculate": "(datum.data_max - datum.data_min) / 18",
                            "as": "bin_width"
                        },
                        {
                            "calculate": "sequence(datum.x_min, datum.x_max, (datum.x_max - datum.x_min) / 150)",
                            "as": "x_seq"
                        },
                        {
                            "flatten": [
                                "x_seq"
                            ]
                        },
                        {
                            "calculate": "datum.x_seq",
                            "as": "x"
                        },
                        {
                            "calculate": "(1 / (datum.stdev * sqrt(2 * PI))) * exp(-0.5 * pow((datum.x - datum.mean) / datum.stdev, 2))",
                            "as": "density"
                        },
                        {
                            "calculate": "datum.density * datum.total_count * datum.bin_width",
                            "as": "y"
                        }
                    ],
                    "mark": {
                        "type": "line",
                        "color": "#1e293b",
                        "strokeWidth": 2.5
                    },
                    "encoding": {
                        "x": {
                            "field": "x",
                            "type": "quantitative"
                        },
                        "y": {
                            "field": "y",
                            "type": "quantitative"
                        }
                    }
                },
                // Mean Line
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "measuredvalue",
                                    "as": "xbar"
                                }
                            ],
                            "groupby": [
                                "lot_breaker_id"
                            ]
                        },
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "xbar",
                                    "as": "grandxbar"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "rule",
                                "color": "#1e293b",
                                "strokeWidth": 2.5
                            },
                            "encoding": {
                                "x": {
                                    "field": "grandxbar",
                                    "type": "quantitative"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#1e293b",
                                "align": "center",
                                "baseline": "bottom",
                                "dy": -10
                            },
                            "encoding": {
                                "x": {
                                    "field": "grandxbar",
                                    "type": "quantitative"
                                },
                                "y": {
                                    "value": 0
                                },
                                "text": {
                                    "value": "Mean"
                                }
                            }
                        }
                    ]
                },
                // LSL Line
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "max",
                                    "field": "lowerlimit",
                                    "as": "lsl"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "rule",
                                "color": "#dc2626",
                                "strokeWidth": 2.5
                            },
                            "encoding": {
                                "x": {
                                    "field": "lsl",
                                    "type": "quantitative"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#dc2626",
                                "align": "center",
                                "baseline": "bottom",
                                "dy": -10
                            },
                            "encoding": {
                                "x": {
                                    "field": "lsl",
                                    "type": "quantitative"
                                },
                                "y": {
                                    "value": 0
                                },
                                "text": {
                                    "value": "LSL"
                                }
                            }
                        }
                    ]
                },
                // USL Line
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "max",
                                    "field": "upperlimit",
                                    "as": "usl"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "rule",
                                "color": "#dc2626",
                                "strokeWidth": 2.5
                            },
                            "encoding": {
                                "x": {
                                    "field": "usl",
                                    "type": "quantitative"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 13,
                                "fontWeight": "bold",
                                "color": "#dc2626",
                                "align": "center",
                                "baseline": "bottom",
                                "dy": -10
                            },
                            "encoding": {
                                "x": {
                                    "field": "usl",
                                    "type": "quantitative"
                                },
                                "y": {
                                    "value": 0
                                },
                                "text": {
                                    "value": "USL"
                                }
                            }
                        }
                    ]
                },
                // UCL Line
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "measuredvalue",
                                    "as": "xbar"
                                },
                                {
                                    "op": "max",
                                    "field": "measuredvalue",
                                    "as": "max_val"
                                },
                                {
                                    "op": "min",
                                    "field": "measuredvalue",
                                    "as": "min_val"
                                },
                                {
                                    "op": "max",
                                    "field": "sampleqty",
                                    "as": "n"
                                }
                            ],
                            "groupby": [
                                "lot_breaker_id"
                            ]
                        },
                        {
                            "calculate": "datum.max_val - datum.min_val",
                            "as": "range"
                        },
                        {
                            "joinaggregate": [
                                {
                                    "op": "mean",
                                    "field": "xbar",
                                    "as": "grandxbar"
                                },
                                {
                                    "op": "mean",
                                    "field": "range",
                                    "as": "rbar"
                                }
                            ]
                        },
                        {
                            "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
                            "as": "a2"
                        },
                        {
                            "calculate": "datum.grandxbar + (datum.a2 * datum.rbar)",
                            "as": "ucl"
                        },
                        {
                            "aggregate": [
                                {
                                    "op": "max",
                                    "field": "ucl",
                                    "as": "ucl_val"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "rule",
                                "strokeDash": [
                                    8,
                                    4
                                ],
                                "color": "#ea580c",
                                "strokeWidth": 2
                            },
                            "encoding": {
                                "x": {
                                    "field": "ucl_val",
                                    "type": "quantitative"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "fontWeight": "bold",
                                "color": "#ea580c",
                                "align": "center",
                                "baseline": "bottom",
                                "dy": -10
                            },
                            "encoding": {
                                "x": {
                                    "field": "ucl_val",
                                    "type": "quantitative"
                                },
                                "y": {
                                    "value": 0
                                },
                                "text": {
                                    "value": "UCL"
                                }
                            }
                        }
                    ]
                },
                // LCL Line
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "measuredvalue",
                                    "as": "xbar"
                                },
                                {
                                    "op": "max",
                                    "field": "measuredvalue",
                                    "as": "max_val"
                                },
                                {
                                    "op": "min",
                                    "field": "measuredvalue",
                                    "as": "min_val"
                                },
                                {
                                    "op": "max",
                                    "field": "sampleqty",
                                    "as": "n"
                                }
                            ],
                            "groupby": [
                                "lot_breaker_id"
                            ]
                        },
                        {
                            "calculate": "datum.max_val - datum.min_val",
                            "as": "range"
                        },
                        {
                            "joinaggregate": [
                                {
                                    "op": "mean",
                                    "field": "xbar",
                                    "as": "grandxbar"
                                },
                                {
                                    "op": "mean",
                                    "field": "range",
                                    "as": "rbar"
                                }
                            ]
                        },
                        {
                            "calculate": "datum.n == 2 ? 1.880 : datum.n == 3 ? 1.023 : datum.n == 4 ? 0.729 : datum.n == 5 ? 0.577 : datum.n == 6 ? 0.483 : datum.n == 7 ? 0.419 : datum.n == 8 ? 0.373 : datum.n == 9 ? 0.337 : datum.n == 10 ? 0.308 : 0.577",
                            "as": "a2"
                        },
                        {
                            "calculate": "datum.grandxbar - (datum.a2 * datum.rbar)",
                            "as": "lcl"
                        },
                        {
                            "aggregate": [
                                {
                                    "op": "max",
                                    "field": "lcl",
                                    "as": "lcl_val"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "rule",
                                "strokeDash": [
                                    8,
                                    4
                                ],
                                "color": "#ea580c",
                                "strokeWidth": 2
                            },
                            "encoding": {
                                "x": {
                                    "field": "lcl_val",
                                    "type": "quantitative"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "fontWeight": "bold",
                                "color": "#ea580c",
                                "align": "center",
                                "baseline": "bottom",
                                "dy": -10
                            },
                            "encoding": {
                                "x": {
                                    "field": "lcl_val",
                                    "type": "quantitative"
                                },
                                "y": {
                                    "value": 0
                                },
                                "text": {
                                    "value": "LCL"
                                }
                            }
                        }
                    ]
                },
                // +3 Sigma
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "measuredvalue",
                                    "as": "xbar"
                                },
                                {
                                    "op": "max",
                                    "field": "measuredvalue",
                                    "as": "max_val"
                                },
                                {
                                    "op": "min",
                                    "field": "measuredvalue",
                                    "as": "min_val"
                                },
                                {
                                    "op": "max",
                                    "field": "sampleqty",
                                    "as": "n"
                                }
                            ],
                            "groupby": [
                                "lot_breaker_id"
                            ]
                        },
                        {
                            "calculate": "datum.max_val - datum.min_val",
                            "as": "range"
                        },
                        {
                            "joinaggregate": [
                                {
                                    "op": "mean",
                                    "field": "xbar",
                                    "as": "grandxbar"
                                },
                                {
                                    "op": "mean",
                                    "field": "range",
                                    "as": "rbar"
                                }
                            ]
                        },
                        {
                            "calculate": "datum.n == 2 ? 1.128 : datum.n == 3 ? 1.693 : datum.n == 4 ? 2.059 : datum.n == 5 ? 2.326 : datum.n == 6 ? 2.534 : datum.n == 7 ? 2.704 : datum.n == 8 ? 2.847 : datum.n == 9 ? 2.970 : datum.n == 10 ? 3.078 : 2.326",
                            "as": "d2"
                        },
                        {
                            "calculate": "datum.rbar / datum.d2",
                            "as": "sigma"
                        },
                        {
                            "calculate": "datum.grandxbar + (3 * datum.sigma)",
                            "as": "plus3sigma"
                        },
                        {
                            "aggregate": [
                                {
                                    "op": "max",
                                    "field": "plus3sigma",
                                    "as": "p3s"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "rule",
                                "strokeDash": [
                                    4,
                                    4
                                ],
                                "color": "#0d9488",
                                "strokeWidth": 2
                            },
                            "encoding": {
                                "x": {
                                    "field": "p3s",
                                    "type": "quantitative"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "fontWeight": "600",
                                "color": "#0d9488",
                                "align": "center",
                                "baseline": "bottom",
                                "dy": -10
                            },
                            "encoding": {
                                "x": {
                                    "field": "p3s",
                                    "type": "quantitative"
                                },
                                "y": {
                                    "value": 0
                                },
                                "text": {
                                    "value": "+3σ"
                                }
                            }
                        }
                    ]
                },
                {
                    "transform": [
                        {
                            "aggregate": [
                                {
                                    "op": "mean",
                                    "field": "measuredvalue",
                                    "as": "xbar"
                                },
                                {
                                    "op": "max",
                                    "field": "measuredvalue",
                                    "as": "max_val"
                                },
                                {
                                    "op": "min",
                                    "field": "measuredvalue",
                                    "as": "min_val"
                                },
                                {
                                    "op": "max",
                                    "field": "sampleqty",
                                    "as": "n"
                                }
                            ],
                            "groupby": [
                                "lot_breaker_id"
                            ]
                        },
                        {
                            "calculate": "datum.max_val - datum.min_val",
                            "as": "range"
                        },
                        {
                            "joinaggregate": [
                                {
                                    "op": "mean",
                                    "field": "xbar",
                                    "as": "grandxbar"
                                },
                                {
                                    "op": "mean",
                                    "field": "range",
                                    "as": "rbar"
                                }
                            ]
                        },
                        {
                            "calculate": "datum.n == 2 ? 1.128 : datum.n == 3 ? 1.693 : datum.n == 4 ? 2.059 : datum.n == 5 ? 2.326 : datum.n == 6 ? 2.534 : datum.n == 7 ? 2.704 : datum.n == 8 ? 2.847 : datum.n == 9 ? 2.970 : datum.n == 10 ? 3.078 : 2.326",
                            "as": "d2"
                        },
                        {
                            "calculate": "datum.rbar / datum.d2",
                            "as": "sigma"
                        },
                        {
                            "calculate": "datum.grandxbar - (3 * datum.sigma)",
                            "as": "minus3sigma"
                        },
                        {
                            "aggregate": [
                                {
                                    "op": "max",
                                    "field": "minus3sigma",
                                    "as": "m3s"
                                }
                            ]
                        }
                    ],
                    "layer": [
                        {
                            "mark": {
                                "type": "rule",
                                "strokeDash": [
                                    4,
                                    4
                                ],
                                "color": "#0d9488",
                                "strokeWidth": 2
                            },
                            "encoding": {
                                "x": {
                                    "field": "m3s",
                                    "type": "quantitative"
                                }
                            }
                        },
                        {
                            "mark": {
                                "type": "text",
                                "fontSize": 12,
                                "fontWeight": "600",
                                "color": "#0d9488",
                                "align": "center",
                                "baseline": "bottom",
                                "dy": -10
                            },
                            "encoding": {
                                "x": {
                                    "field": "m3s",
                                    "type": "quantitative"
                                },
                                "y": {
                                    "value": 0
                                },
                                "text": {
                                    "value": "-3σ"
                                }
                            }
                        }
                    ]
                }
            ]
        }
    ],
    "config": {
        "view": {
            "stroke": null
        },
        "concat": {
            "spacing": 20
        }
    }
}
